# Game Night Live - Claude Project Context

## Project Overview

**Game Night Live** is an interactive real-time game night platform where hosts stream live game shows and viewers actively participate using their phones as controllers. Think HQ Trivia meets Twitch meets Jackbox Party Pack.

- **Domain**: gamenightsarefun.com
- **Repository**: https://github.com/taketaketaketake/game-nights
- **Status**: MVP development phase

## Core Concept

- Hosts stream live via Twitch/YouTube (embedded)
- Viewers join games and compete in real-time
- Game types: Trivia, Drawing, Physical challenges, Team puzzles
- Live leaderboards with real prizes
- Mobile-first viewer experience (phone as game controller)

## Tech Stack

### Frontend

- **Astro** (NOT Next.js) - User explicitly prefers Astro for performance
- **React Islands** - Only for interactive components
- **TailwindCSS** - Utility-first styling
- **Socket.io Client** - Real-time communication
- **TypeScript** - Type safety
- **Deployed to**: Cloudflare Pages (free)

### Backend

- **Node.js + Express** - REST API server
- **Socket.io** - WebSocket real-time gameplay
- **PostgreSQL** - Primary database
- **Auth0** - User authentication (DO NOT build custom auth)
- **Cloudflare R2** - File storage (NOT AWS S3 - user preference)
- **Deployed to**: Railway or Render

### Optional/Future

- **Redis** - Setup exists but NOT required for MVP. Only enable when scaling to multiple servers.

## Architecture

### Monorepo Structure

```
/
├── frontend/          # Astro application
├── backend/           # Node.js API + Socket.io server
├── docs/              # Documentation
└── docker-compose.yml # Local PostgreSQL
```

### Real-time Flow

1. Player joins game → WebSocket connection
2. Host broadcasts question → All players receive instantly
3. Players submit answers → Backend calculates points
4. Leaderboard updates → Broadcast to all players

### Data Models (PostgreSQL)

- **users** - Auth0 ID, username, stats
- **games** - Scheduled game nights, host info
- **game_sessions** - Live game instances
- **questions** - Trivia questions, drawing prompts
- **scores** - Player points per session
- **teams** - Team collaboration mode
- **prizes** - Winner payouts

## Development Guidelines

### Key Principles

1. **Astro-first**: Keep pages static, use React only for interactivity
2. **Mobile-first**: Phone as primary controller interface
3. **Real-time critical**: Sub-second response times matter
4. **Security**: Auth0 for all authentication, never custom auth
5. **Performance**: Optimize for fast page loads and real-time updates

### Code Style

- **Frontend**: Astro components in `.astro`, React in `.tsx`
- **Backend**: ES6 modules (`import/export`), async/await preferred
- **Database**: Parameterized queries always (SQL injection prevention)
- **WebSocket**: Use Socket.io rooms for game sessions

### Important Conventions

- Environment vars: Use `.env` files, never commit secrets
- Database: Run migrations before seed data
- Socket.io: One room per game session (`game-${sessionId}`)
- File uploads: Always use Cloudflare R2 utilities in `backend/src/utils/storage.js`

## File Structure

### Frontend Key Files

- `src/pages/index.astro` - Landing page (static)
- `src/pages/games/browse.astro` - Game browser (static)
- `src/components/game/GamePlayer.tsx` - Interactive game UI (React)
- `src/components/game/Leaderboard.tsx` - Real-time leaderboard (React)
- `src/lib/socket.ts` - Socket.io client utilities

### Backend Key Files

- `src/server.ts` - Express + Socket.io setup (TypeScript)
- `src/routes/games.ts` - Game CRUD API (TypeScript)
- `src/routes/users.ts` - User management API (TypeScript)
- `src/routes/leaderboard.ts` - Leaderboard API (TypeScript)
- `src/sockets/gameRoom.js` - Real-time game logic
- `src/sockets/chat.js` - Real-time chat functionality
- `src/config/db.ts` - PostgreSQL connection (TypeScript)
- `src/utils/storage.js` - Cloudflare R2 uploads (native fetch API)
- `src/middleware/rateLimiting.ts` - Rate limiting protection

### Database Files

- `database/schema.sql` - Complete database schema
- `database/migrate.js` - Run with `npm run db:migrate` (uses tsx)
- `database/seed.js` - Sample data with `npm run db:seed` (uses tsx)

## Common Tasks

### Setup from Scratch

```bash
# Start PostgreSQL
docker-compose up -d

# Install dependencies
cd frontend && npm install
cd ../backend && npm install

# Configure environment variables
cp frontend/.env.example frontend/.env
cp backend/.env.example backend/.env
# Edit both .env files with real credentials

# Initialize database
cd backend
npm run db:migrate
npm run db:seed

# Start development servers (2 terminals)
# Terminal 1:
cd backend && npm run dev

# Terminal 2:
cd frontend && npm run dev
```

### Running Locally

- Backend: http://localhost:3000
- Frontend: http://localhost:4321
- PostgreSQL: localhost:5432

### Database Operations

```bash
cd backend

# Run migrations
npm run db:migrate

# Seed sample data
npm run db:seed

# Connect to database
psql postgresql://postgres:postgres@localhost:5432/gamenightlive
```

### Deployment

- Frontend: Auto-deploy via Cloudflare Pages on `git push`
- Backend: Auto-deploy via Railway/Render on `git push`
- See `docs/DEPLOYMENT.md` for full guide

## Environment Variables

### Frontend (.env)

```
PUBLIC_AUTH0_DOMAIN=
PUBLIC_AUTH0_CLIENT_ID=
AUTH0_CLIENT_SECRET=
AUTH0_SECRET=
PUBLIC_API_URL=http://localhost:3000
PUBLIC_WS_URL=http://localhost:3000
```

### Backend (.env)

```
PORT=3000
DATABASE_URL=postgresql://...
FRONTEND_URL=http://localhost:4321
AUTH0_DOMAIN=
AUTH0_AUDIENCE=
R2_ENDPOINT=
R2_ACCESS_KEY_ID=
R2_SECRET_ACCESS_KEY=
R2_BUCKET=
R2_PUBLIC_URL=
# REDIS_URL= (optional, for scaling)
```

## Critical Dependencies

### Frontend

- `astro` - Framework
- `@astrojs/react` - React integration
- `@astrojs/tailwind` - Tailwind CSS
- `socket.io-client` - Real-time client
- `@auth/core` - Auth0 integration

### Backend

- `express` - Web framework
- `socket.io` - WebSocket server
- `pg` - PostgreSQL client
- `express-rate-limit` - API rate limiting protection
- `cors` - CORS middleware
- `dotenv` - Environment variables
- `tsx` - TypeScript execution
- `typescript` - Type checking
- `@types/express` - TypeScript types for Express

## Known Issues & Solutions

### Database Connection Fails

- Check Docker is running: `docker-compose ps`
- Verify `DATABASE_URL` in backend/.env
- Run migrations if fresh database

### Socket.io Won't Connect

- Ensure backend running on port 3000
- Check CORS settings in `backend/src/server.js`
- Verify `PUBLIC_WS_URL` matches backend URL

### Auth0 Errors

- Confirm callback URLs in Auth0 dashboard match app URLs
- Check Auth0 credentials in .env files
- Ensure Auth0 domain format is correct (e.g., `your-app.auth0.com`)

### File Upload Fails

- Verify R2 credentials are correct
- Check bucket name matches `R2_BUCKET`
- Ensure bucket has public access if needed

## Testing Strategy

### Current (MVP)

- Manual testing in browser
- Multiple browser windows to simulate multiplayer

### Future

- Unit tests: Jest for backend, Vitest for frontend
- Integration tests: API endpoints
- E2E tests: Playwright for full game flow

## Performance Considerations

### Frontend

- Astro pre-renders static pages
- Lazy load React components
- Optimize images (WebP format)
- Minimize JavaScript bundle

### Backend

- Connection pooling (PostgreSQL)
- Room-based Socket.io for efficient broadcasting
- Database indexes on frequently queried fields
- Enable Redis when scaling to multiple servers

### Real-time

- Current: Single server handles 100-500 concurrent users
- With Redis: Multiple servers handle 10,000+ users
- Sub-second question delivery is critical

## Security

### Authentication

- Auth0 handles all user authentication
- JWT tokens for API requests
- Never store passwords in database

### Database

- Parameterized queries only (prevent SQL injection)
- Connection via environment variables
- Read-only user for frontend if needed

### API

- CORS configured for specific origins
- Rate limiting implemented with express-rate-limit:
  - General: 100 requests/15min per IP
  - Auth: 5 attempts/15min per IP  
  - Games: 30 actions/min per IP
  - Strict: 3 operations/hour per IP
  - Uploads: 10 uploads/15min per IP
- Input validation on all endpoints

### File Uploads

- Cloudflare R2 storage using native fetch API (no AWS SDK dependency)
- Validate file types and sizes
- Scan uploads for malicious content (future)
- Use Cloudflare R2 signed URLs if needed

## Scaling Strategy

### Phase 1: MVP (Current)

- Single backend server
- In-memory game state
- 100-500 concurrent users
- Cost: $5-10/month

### Phase 2: Growth

- Enable Redis adapter
- Multiple backend servers
- Load balancer
- 1,000-10,000 users
- Cost: $50-100/month

### Phase 3: Scale

- Multi-region deployment
- Database read replicas
- CDN optimization
- 100,000+ users

## Important Notes for Claude

### User Preferences

- ✅ Prefers **Astro** over Next.js
- ✅ Prefers **Cloudflare R2** over AWS S3
- ✅ Uses **Auth0** for authentication
- ✅ Redis setup exists but should NOT be enabled unless scaling

### What NOT to Suggest

- ❌ Don't suggest Next.js (use Astro)
- ❌ Don't suggest AWS S3 (use Cloudflare R2)
- ❌ Don't suggest custom authentication (use Auth0)
- ❌ Don't enable Redis for MVP (only when scaling)
- ❌ Don't suggest MongoDB (using PostgreSQL)

### Development Workflow

1. Always read existing code before suggesting changes
2. Test changes with both frontend and backend running
3. Use database migrations for schema changes
4. Keep mobile-first approach in mind
5. Ensure real-time features work smoothly

### When Making Changes

- **Frontend**: Test on mobile viewport first
- **Backend**: Ensure Socket.io events are handled
- **Database**: Always use migrations, never direct SQL in code
- **Styling**: Use Tailwind utility classes consistently
- **Types**: Add TypeScript types for new components

## Helpful Commands Reference

```bash
# Development (TypeScript)
npm run dev          # Start dev server with tsx
npm run dev:watch    # Start with auto-restart
npm run build        # Compile TypeScript to JavaScript
npm run start        # Run compiled JavaScript
npm run type-check   # Check TypeScript types

# Database
npm run db:migrate   # Run migrations with tsx
npm run db:seed      # Seed sample data with tsx

# Docker
docker-compose up -d              # Start PostgreSQL
docker-compose down               # Stop PostgreSQL
docker-compose logs postgres      # View PostgreSQL logs

# Git
git add . && git commit -m "message" && git push origin main
```

## Resources

- **Setup Guide**: `docs/SETUP.md`
- **Architecture**: `docs/ARCHITECTURE.md`
- **Deployment**: `docs/DEPLOYMENT.md`
- **Full Context**: `CONTEXT.md`

---

**Last Updated**: December 5, 2024
**Current Phase**: MVP Development - TypeScript Backend + Rate Limiting ✅
**Recent Updates**: 
- ✅ Backend converted to TypeScript
- ✅ Rate limiting implemented for API security
- ✅ Cloudflare R2 storage using native fetch (no AWS dependency)
**Next Milestone**: Set up Auth0 + Database connection